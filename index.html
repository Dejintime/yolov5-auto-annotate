<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>YOLOv5 å®è®­å¹³å°</title>
    <!-- å¼•å…¥æ ·å¼å’Œåº“ (å›½å†…é•œåƒæº) -->
    <link rel="stylesheet" href="https://cdn.staticfile.org/element-plus/2.3.14/index.min.css" />
    <script src="https://cdn.staticfile.org/vue/3.3.4/vue.global.min.js"></script>
    <script src="https://cdn.staticfile.org/element-plus/2.3.14/index.full.min.js"></script>
    <script src="https://cdn.staticfile.org/axios/1.6.0/axios.min.js"></script>
    <script src="https://cdn.staticfile.org/fabric.js/5.3.0/fabric.min.js"></script>
    <style>
        body { margin: 0; padding: 20px; font-family: "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "å¾®è½¯é›…é»‘", Arial, sans-serif; background: #f5f7fa; }
        .main-card { min-height: 80vh; }
        .container { display: flex; gap: 20px; height: 70vh; }
        .sidebar { width: 300px; display: flex; flex-direction: column; gap: 15px; }
        .canvas-area { flex: 1; background: #eee; border-radius: 4px; overflow: hidden; display: flex; justify-content: center; align-items: center; border: 1px solid #ddd; }
        .log-box { background: #1e1e1e; color: #00ff00; padding: 15px; border-radius: 4px; font-family: monospace; height: 300px; overflow-y: auto; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="app">
        <el-card class="main-card">
            <template #header>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="margin:0">ğŸš€ YOLOv5 è‡ªåŠ¨å›¾åƒç›®æ ‡æ£€æµ‹ä¸æ ‡æ³¨ç³»ç»Ÿ</h2>
                    <el-tag type="info">å®è®­é¡¹ç›® v1.0</el-tag>
                </div>
            </template>

            <el-tabs v-model="activeTab">
                
                <!-- ================= æ ‡ç­¾é¡µ 1: æ™ºèƒ½æ ‡æ³¨ ================= -->
                <el-tab-pane label="ğŸ–¼ï¸ æ™ºèƒ½æ ‡æ³¨ & æ•°æ®å‡†å¤‡" name="annotation">
                    <div class="container">
                        <!-- å·¦ä¾§æ“ä½œæ  -->
                        <div class="sidebar">
                            <el-card shadow="never">
                                <template #header><b>1. å›¾åƒä¸Šä¼ </b></template>
                                <el-upload
                                    action="#"
                                    :auto-upload="false"
                                    :on-change="handleFileChange"
                                    :show-file-list="false">
                                    <el-button type="primary" style="width: 100%;">é€‰æ‹©å›¾ç‰‡å¹¶æ£€æµ‹</el-button>
                                </el-upload>
                                <div v-if="currentFile" style="margin-top: 10px; font-size: 12px; color: #666;">
                                    å½“å‰: {{ currentFile.name }}
                                </div>
                            </el-card>

                            <el-card shadow="never" v-if="activeObject">
                                <template #header><b>2. ä¿®æ­£æ ‡æ³¨</b></template>
                                <el-form label-position="top" size="small">
                                    <el-form-item label="ç±»åˆ«åç§°">
                                        <el-input v-model="activeObject.label" @input="updateLabel"></el-input>
                                    </el-form-item>
                                    <el-button type="danger" plain style="width: 100%;" @click="deleteActiveObject">åˆ é™¤æ­¤æ¡† (Del)</el-button>
                                </el-form>
                            </el-card>
                            <el-alert v-else title="ç‚¹å‡»ç”»å¸ƒä¸Šçš„æ¡†è¿›è¡Œä¿®æ”¹" type="info" :closable="false"></el-alert>

                            <div style="margin-top: auto;">
                                <el-button type="success" size="large" style="width: 100%;" @click="saveAnnotations" :loading="saving">
                                    3. ä¿å­˜ç»“æœ (XML+å›¾)
                                </el-button>
                            </div>
                        </div>

                        <!-- å³ä¾§ç”»å¸ƒ -->
                        <div class="canvas-area" id="canvas-wrapper">
                            <canvas id="c"></canvas>
                        </div>
                    </div>
                </el-tab-pane>

                <!-- ================= æ ‡ç­¾é¡µ 2: æ¨¡å‹è®­ç»ƒ ================= -->
                <el-tab-pane label="ğŸ”¥ æ¨¡å‹è®­ç»ƒ & è¯„ä¼°" name="training">
                    <el-row :gutter="20">
                        <!-- è®­ç»ƒé…ç½® -->
                        <el-col :span="8">
                            <el-card header="è®­ç»ƒå‚æ•°é…ç½®">
                                <el-form label-width="100px">
                                    <el-form-item label="Epochs">
                                        <el-input-number v-model="trainConfig.epochs" :min="1" :max="300"></el-input-number>
                                    </el-form-item>
                                    <el-form-item label="Batch Size">
                                        <el-select v-model="trainConfig.batch_size">
                                            <el-option :value="4" label="4 (ä½æ˜¾å­˜)"></el-option>
                                            <el-option :value="8" label="8"></el-option>
                                            <el-option :value="16" label="16 (æ¨è)"></el-option>
                                            <el-option :value="32" label="32"></el-option>
                                        </el-select>
                                    </el-form-item>
                                    <el-form-item label="é¢„è®­ç»ƒæƒé‡">
                                        <el-input v-model="trainConfig.weights" disabled></el-input>
                                    </el-form-item>
                                    
                                    <el-divider></el-divider>
                                    
                                    <el-button 
                                        type="danger" 
                                        style="width: 100%;" 
                                        @click="startTraining" 
                                        :loading="trainStatus.is_training"
                                        :disabled="trainStatus.is_training">
                                        {{ trainStatus.is_training ? 'è®­ç»ƒè¿›è¡Œä¸­...' : 'å¼€å§‹è®­ç»ƒ (Start Training)' }}
                                    </el-button>
                                </el-form>
                            </el-card>

                            <el-card header="æ¨¡å‹è¯„ä¼°" style="margin-top: 20px;">
                                <p style="font-size: 12px; color: #666;">ä½¿ç”¨éªŒè¯é›†è¯„ä¼°å½“å‰æœ€ä½³æ¨¡å‹ (best.pt)</p>
                                <el-button type="primary" plain style="width: 100%;" @click="startEvaluation" :loading="evaluating">
                                    è¿è¡Œè¯„ä¼° (Val)
                                </el-button>
                            </el-card>
                        </el-col>

                        <!-- æ—¥å¿—è¾“å‡ºä¸ç»“æœå±•ç¤º -->
                        <el-col :span="16">
                            <!-- æ–°å¢ï¼šè¯„ä¼°æŒ‡æ ‡ä»ªè¡¨ç›˜ -->
                            <div v-if="evalMetrics" style="margin-bottom: 20px;">
                                <el-row :gutter="10">
                                    <el-col :span="6">
                                        <el-card shadow="hover" style="text-align: center; background: #f0f9eb;">
                                            <div style="font-size: 12px; color: #666;">ç²¾ç¡®ç‡ (P)</div>
                                            <div style="font-size: 24px; font-weight: bold; color: #67c23a;">{{ evalMetrics.precision }}</div>
                                        </el-card>
                                    </el-col>
                                    <el-col :span="6">
                                        <el-card shadow="hover" style="text-align: center; background: #e1f3d8;">
                                            <div style="font-size: 12px; color: #666;">å¬å›ç‡ (R)</div>
                                            <div style="font-size: 24px; font-weight: bold; color: #409eff;">{{ evalMetrics.recall }}</div>
                                        </el-card>
                                    </el-col>
                                    <el-col :span="6">
                                        <el-card shadow="hover" style="text-align: center; background: #fdf6ec;">
                                            <div style="font-size: 12px; color: #666;">mAP@0.5</div>
                                            <div style="font-size: 24px; font-weight: bold; color: #e6a23c;">{{ evalMetrics.map50 }}</div>
                                        </el-card>
                                    </el-col>
                                    <el-col :span="6">
                                        <el-card shadow="hover" style="text-align: center; background: #fef0f0;">
                                            <div style="font-size: 12px; color: #666;">mAP@0.5:0.95</div>
                                            <div style="font-size: 24px; font-weight: bold; color: #f56c6c;">{{ evalMetrics.map95 }}</div>
                                        </el-card>
                                    </el-col>
                                </el-row>
                            </div>

                            <el-card header="ç³»ç»Ÿæ—¥å¿— / ç»ˆç«¯è¾“å‡º">
                                <div class="log-box">
                                    <div v-if="trainStatus.is_training">
                                        > çŠ¶æ€: æ­£åœ¨è®­ç»ƒä¸­...<br>
                                        > æ¶ˆæ¯: {{ trainStatus.message }}<br>
                                        > <span class="blink">_</span>
                                    </div>
                                    <div v-else>
                                        > çŠ¶æ€: {{ trainStatus.message }}
                                    </div>
                                    <el-divider border-style="dashed" content-position="left">è¯¦ç»†æ—¥å¿—</el-divider>
                                    <div v-if="evalOutput">{{ evalOutput }}</div>
                                </div>
                            </el-card>
                        </el-col>
                    </el-row>
                </el-tab-pane>

            </el-tabs>
        </el-card>
    </div>

    <script>
        const { createApp, ref, onMounted, onUnmounted } = Vue;

        const app = createApp({
            setup() {
                // --- é€šç”¨çŠ¶æ€ ---
                const activeTab = ref('annotation');

                // --- æ ‡æ³¨åŠŸèƒ½çŠ¶æ€ ---
                const canvas = ref(null);
                const currentFile = ref(null);
                const activeObject = ref(null);
                const saving = ref(false);
                const imageScale = ref(1);

                // --- è®­ç»ƒåŠŸèƒ½çŠ¶æ€ ---
                const trainConfig = ref({
                    epochs: 50,
                    batch_size: 16,
                    weights: 'yolov5s.pt'
                });
                const trainStatus = ref({ is_training: false, message: 'Idle' });
                const evaluating = ref(false);
                const evalOutput = ref('');
                const evalMetrics = ref(null); // æ–°å¢ï¼šç”¨äºå­˜å‚¨è§£æåçš„æŒ‡æ ‡
                let statusTimer = null;

                // ================== æ ‡æ³¨é€»è¾‘ ==================
                onMounted(() => {
                    // åˆå§‹åŒ– Fabric
                    canvas.value = new fabric.Canvas('c');
                    canvas.value.on('selection:created', handleSelection);
                    canvas.value.on('selection:updated', handleSelection);
                    canvas.value.on('selection:cleared', () => activeObject.value = null);
                    
                    document.addEventListener('keydown', (e) => {
                        if ((e.key === 'Delete' || e.key === 'Backspace') && activeTab.value === 'annotation') {
                            deleteActiveObject();
                        }
                    });

                    // å¯åŠ¨å®šæ—¶å™¨è½®è¯¢è®­ç»ƒçŠ¶æ€
                    statusTimer = setInterval(checkTrainingStatus, 2000);
                });

                onUnmounted(() => {
                    if (statusTimer) clearInterval(statusTimer);
                });

                const handleSelection = (e) => {
                    const selected = e.selected[0];
                    if (selected) {
                        activeObject.value = {
                            label: selected.label || 'unknown',
                            ref: selected
                        };
                    }
                };

                const updateLabel = () => {
                    if (activeObject.value?.ref) {
                        activeObject.value.ref.set('label', activeObject.value.label);
                        canvas.value.requestRenderAll();
                    }
                };

                const deleteActiveObject = () => {
                    const active = canvas.value.getActiveObject();
                    if (active) {
                        canvas.value.remove(active);
                        activeObject.value = null;
                    }
                };

                const handleFileChange = async (file) => {
                    currentFile.value = file.raw;
                    const reader = new FileReader();
                    reader.onload = (f) => {
                        fabric.Image.fromURL(f.target.result, (img) => {
                            // åŠ¨æ€è°ƒæ•´ Canvas å¤§å°
                            const wrapper = document.getElementById('canvas-wrapper');
                            const maxWidth = wrapper.clientWidth - 40; 
                            const scale = img.width > maxWidth ? maxWidth / img.width : 1;
                            imageScale.value = scale;

                            img.set({ scaleX: scale, scaleY: scale, selectable: false });
                            canvas.value.setWidth(img.width * scale);
                            canvas.value.setHeight(img.height * scale);
                            canvas.value.setBackgroundImage(img, canvas.value.renderAll.bind(canvas.value));
                        });
                    };
                    reader.readAsDataURL(file.raw);

                    // è°ƒç”¨åç«¯é¢„æµ‹
                    const formData = new FormData();
                    formData.append('file', file.raw);
                    try {
                        const res = await axios.post('http://127.0.0.1:8000/predict', formData);
                        drawBoxes(res.data.detections);
                        ElementPlus.ElMessage.success('æ£€æµ‹å®Œæˆ');
                    } catch (error) {
                        ElementPlus.ElMessage.error('æ£€æµ‹å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯');
                    }
                };

                const drawBoxes = (detections) => {
                    canvas.value.getObjects().forEach(o => canvas.value.remove(o));
                    detections.forEach(det => {
                        const scale = imageScale.value;
                        const rect = new fabric.Rect({
                            left: det.xmin * scale,
                            top: det.ymin * scale,
                            width: (det.xmax - det.xmin) * scale,
                            height: (det.ymax - det.ymin) * scale,
                            fill: 'rgba(255,0,0,0.1)',
                            stroke: 'red',
                            strokeWidth: 2,
                            hasControls: true,
                            hasBorders: true,
                            lockRotation: true,
                            uniformScaling: false, // å…è®¸è‡ªç”±æ‹‰ä¼¸
                            transparentCorners: false,
                            cornerColor: 'blue',
                            cornerSize: 10,
                            label: det.name
                        });
                        canvas.value.add(rect);
                    });
                    canvas.value.requestRenderAll();
                };

                const saveAnnotations = async () => {
                    if (!currentFile.value) return;
                    saving.value = true;
                    
                    const boxes = [];
                    const scale = imageScale.value;
                    
                    canvas.value.getObjects().forEach(obj => {
                        if (obj.type === 'rect') {
                            boxes.push({
                                xmin: obj.left / scale,
                                ymin: obj.top / scale,
                                xmax: (obj.left + obj.getScaledWidth()) / scale,
                                ymax: (obj.top + obj.getScaledHeight()) / scale,
                                label: obj.label || 'unknown'
                            });
                        }
                    });

                    try {
                        const res = await axios.post('http://127.0.0.1:8000/save_annotation', {
                            filename: currentFile.value.name,
                            width: Math.round(canvas.value.width / scale),
                            height: Math.round(canvas.value.height / scale),
                            boxes: boxes,
                            save_image: true
                        });
                        ElementPlus.ElMessage.success(`ä¿å­˜æˆåŠŸ: ${res.data.xml_path}`);
                    } catch (error) {
                        ElementPlus.ElMessage.error('ä¿å­˜å¤±è´¥');
                    } finally {
                        saving.value = false;
                    }
                };

                // ================== è®­ç»ƒé€»è¾‘ ==================
                
                const startTraining = async () => {
                    try {
                        const res = await axios.post('http://127.0.0.1:8000/train', trainConfig.value);
                        if (res.data.status === 'success') {
                            ElementPlus.ElMessage.success('è®­ç»ƒä»»åŠ¡å·²åœ¨åå°å¯åŠ¨');
                            trainStatus.value.is_training = true;
                        } else {
                            ElementPlus.ElMessage.warning(res.data.message);
                        }
                    } catch (error) {
                        ElementPlus.ElMessage.error('å¯åŠ¨è®­ç»ƒå¤±è´¥');
                    }
                };

                const checkTrainingStatus = async () => {
                    try {
                        const res = await axios.get('http://127.0.0.1:8000/train/status');
                        trainStatus.value = res.data;
                    } catch (error) {
                        console.log('Status check failed');
                    }
                };

                const startEvaluation = async () => {
                    evaluating.value = true;
                    evalOutput.value = 'æ­£åœ¨è¯„ä¼°ä¸­ï¼Œè¯·ç¨å€™...';
                    evalMetrics.value = null; // æ¸…ç©ºæ—§æ•°æ®
                    
                    try {
                        const res = await axios.post('http://127.0.0.1:8000/evaluate', {
                            weights: 'runs/train/custom_exp/weights/best.pt',
                            data_yaml: 'coco128.yaml'
                        });
                        if (res.data.status === 'success') {
                            evalOutput.value = res.data.output;
                            // æ–°å¢ï¼šä¿å­˜æŒ‡æ ‡æ•°æ®
                            if (res.data.metrics) {
                                evalMetrics.value = res.data.metrics;
                            }
                            ElementPlus.ElMessage.success('è¯„ä¼°å®Œæˆ');
                        } else {
                            evalOutput.value = `Error: ${res.data.message}\n${res.data.error}`;
                        }
                    } catch (error) {
                        evalOutput.value = 'è¯·æ±‚å¤±è´¥';
                    } finally {
                        evaluating.value = false;
                    }
                };

                return {
                    activeTab,
                    // æ ‡æ³¨
                    currentFile, activeObject, saving,
                    handleFileChange, updateLabel, deleteActiveObject, saveAnnotations,
                    // è®­ç»ƒ
                    trainConfig, trainStatus, evaluating, evalOutput, evalMetrics, // è®°å¾—å¯¼å‡º evalMetrics
                    startTraining, startEvaluation
                };
            }
        });

        app.use(ElementPlus);
        app.mount('#app');
    </script>
</body>
</html>